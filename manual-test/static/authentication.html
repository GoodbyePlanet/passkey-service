<!DOCTYPE html>
<html>
<body>
<script>
    async function authenticate() {
        const beginAuthenticationResponse = await fetch("http://localhost:8080/api/authenticate/begin", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            credentials: "include",
            body: JSON.stringify({username: "doe"})
        }).then(r => r.json());
        console.log("Begin Registration Response: ", beginAuthenticationResponse);

        const publicKey = beginAuthenticationResponse.publicKey;

        publicKey.challenge = Uint8Array.from(atob(publicKey.challenge.replace(/-/g, "+").replace(/_/g, "/")), c => c.charCodeAt(0));

        if (publicKey.allowCredentials) {
            publicKey.allowCredentials = publicKey.allowCredentials.map(cred => ({
                ...cred,
                id: Uint8Array.from(atob(cred.id.replace(/-/g, "+").replace(/_/g, "/")), c => c.charCodeAt(0))
            }));
        }

        const assertion = await navigator.credentials.get({publicKey});
        console.log("Assertion:", assertion);

        function bufferToBase64url(buffer) {
            return btoa(String.fromCharCode(...new Uint8Array(buffer)))
                .replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/, "");
        }

        const data = {
            id: assertion.id,
            rawId: bufferToBase64url(assertion.rawId),
            type: assertion.type,
            response: {
                authenticatorData: bufferToBase64url(assertion.response.authenticatorData),
                clientDataJSON: bufferToBase64url(assertion.response.clientDataJSON),
                signature: bufferToBase64url(assertion.response.signature),
                userHandle: assertion.response.userHandle ? bufferToBase64url(assertion.response.userHandle) : null
            }
        };

        console.log(JSON.stringify(data, null, 2));
        const finishAuthenticationResponse = await fetch("http://localhost:8080/api/authenticate/finish", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            credentials: "include",
            body: JSON.stringify(data)
        }).then(r => r.json());

        console.log("Finish Authentication Response: ", finishAuthenticationResponse);
    }

    authenticate();
</script>
</body>
</html>
