<!DOCTYPE html>
<html>
<body>
<script>
    async function register() {
        const begin = await fetch("http://localhost:8080/api/register/begin", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            credentials: "include",
            body: JSON.stringify({username: "doe", displayName: "doe"}),
        }).then(r => r.json());

        console.log("Begin:", begin);
        const publicKey = begin.publicKey;
        publicKey.challenge = Uint8Array.from(
            atob(base64urlToBase64(publicKey.challenge)),
            c => c.charCodeAt(0)
        );
        publicKey.user.id = Uint8Array.from(
            atob(base64urlToBase64(publicKey.user.id)),
            c => c.charCodeAt(0)
        );
        const cred = await navigator.credentials.create({publicKey});
        console.log("Credential:", cred);

        // Convert ArrayBuffers to base64url
        function bufferToBase64url(buffer) {
            return btoa(String.fromCharCode(...new Uint8Array(buffer)))
                .replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/, "");
        }

        function base64urlToBase64(base64url) {
            base64url = base64url.replace(/-/g, "+").replace(/_/g, "/");
            const pad = base64url.length % 4;
            if (pad) {
                base64url += "=".repeat(4 - pad);
            }
            return base64url;
        }

        const attestationResponse = cred.response;
        const data = {
            id: cred.id,
            rawId: bufferToBase64url(cred.rawId),
            type: cred.type,
            response: {
                attestationObject: bufferToBase64url(attestationResponse.attestationObject),
                clientDataJSON: bufferToBase64url(attestationResponse.clientDataJSON)
            }
        };
        console.log(JSON.stringify(data, null, 2));

        const finish = await fetch("http://localhost:8080/api/register/finish", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            credentials: "include",
            body: JSON.stringify(data)
        }).then(r => r.json());

        console.log("Finish:", finish);
    }

    register();
</script>
</body>
</html>

